<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจำลองการเลือกโรงเรียนสำหรับรองผู้อำนวยการ</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .disabled-row { opacity: 0.5; pointer-events: none; }
        .saved-row { background-color: #f0f9ff; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
                ระบบจำลองการเลือกโรงเรียนสำหรับรองผู้อำนวยการ
            </h1>
            
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-blue-600 text-white">
                            <th class="border border-gray-300 px-4 py-3 text-center font-semibold">ลำดับที่</th>
                            <th class="border border-gray-300 px-4 py-3 text-center font-semibold">สถานการณ์ที่ 1</th>
                            <th class="border border-gray-300 px-4 py-3 text-center font-semibold">สถานการณ์ที่ 2</th>
                            <th class="border border-gray-300 px-4 py-3 text-center font-semibold">สถานการณ์ที่ 3</th>
                            <th class="border border-gray-300 px-4 py-3 text-center font-semibold">การดำเนินการ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Rows will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>
                       
            <div id="loadingMessage" class="hidden text-center mt-4 text-blue-600">
                กำลังโหลดข้อมูล...
            </div>
        </div>
    </div>

    <script>
        const schools = [
            'โรงเรียนวัดแม่กะ',
            'โรงเรียนบ้านทุ่งโป่ง',
            'โรงเรียนบ้านร่มหลวง',
            'โรงเรียนบ้านกาดฮาว',
            'โรงเรียนบ้านแม่ปั๋ง',
            'โรงเรียนบ้านปางห้วยตาด',
            'โรงเรียนสบเปิงวิทยา',
            'โรงเรียนร่ำเปิงวิทยา',
            'โรงเรียนบ้านเป้าวิทยาคาร',
            'โรงเรียนบ้านสันคะยอม',
            'โรงเรียนบ้านหนองปลามัน',
            'โรงเรียนบ้านป่าติ้ว',
            'โรงเรียนวัดสันทรายมูล (มงคลวิทยา)',
            'โรงเรียนบ้านแม่แฝก'
        ];

        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwI9YuD5qNbG7_wc1ZnEOgg389ZAVB5ReZ7clyFLA0u6MdICYzIeHYkgCfadbxVtpCT0w/exec';
        
        let tableData = {};
        let savedRows = new Set();

        function initializeTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            for (let i = 1; i <= 14; i++) {
                const row = document.createElement('tr');
                row.id = `row-${i}`;
                row.className = i === 1 ? '' : 'disabled-row';
                
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-3 text-center font-medium">${i}</td>
                    <td class="border border-gray-300 px-4 py-3">
                        <select id="scenario1-${i}" class="w-full p-2 border rounded" onchange="handleSelection(1, ${i}, this.value)" ${i === 1 ? '' : 'disabled'}>
                            <option value="">เลือกโรงเรียน</option>
                        </select>
                    </td>
                    <td class="border border-gray-300 px-4 py-3">
                        <select id="scenario2-${i}" class="w-full p-2 border rounded" onchange="handleSelection(2, ${i}, this.value)" ${i === 1 ? '' : 'disabled'}>
                            <option value="">เลือกโรงเรียน</option>
                        </select>
                    </td>
                    <td class="border border-gray-300 px-4 py-3">
                        <select id="scenario3-${i}" class="w-full p-2 border rounded" onchange="handleSelection(3, ${i}, this.value)" ${i === 1 ? '' : 'disabled'}>
                            <option value="">เลือกโรงเรียน</option>
                        </select>
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        <button id="save-${i}" onclick="saveRow(${i})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium transition-colors" ${i === 1 ? '' : 'disabled'}>
                            บันทึก
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            }
            
            updateAllSelects();
        }

        function updateAllSelects() {
            for (let scenario = 1; scenario <= 3; scenario++) {
                updateSelectOptions(scenario);
            }
        }

        function updateSelectOptions(scenario) {
            const usedSchools = new Set();
            
            // Collect used schools in this scenario
            for (let row = 1; row <= 14; row++) {
                const select = document.getElementById(`scenario${scenario}-${row}`);
                if (select && select.value && select.value !== 'สละสิทธิ์') {
                    usedSchools.add(select.value);
                }
            }
            
            // Update all selects in this scenario
            for (let row = 1; row <= 14; row++) {
                const select = document.getElementById(`scenario${scenario}-${row}`);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">เลือกโรงเรียน</option>';
                    
                    // Add available schools
                    schools.forEach(school => {
                        if (!usedSchools.has(school) || school === currentValue) {
                            const option = document.createElement('option');
                            option.value = school;
                            option.textContent = school;
                            select.appendChild(option);
                        }
                    });
                    
                    // Always add สละสิทธิ์ option
                    const waiveOption = document.createElement('option');
                    waiveOption.value = 'สละสิทธิ์';
                    waiveOption.textContent = 'สละสิทธิ์';
                    select.appendChild(waiveOption);
                    
                    // Restore current value
                    select.value = currentValue;
                }
            }
        }

        function handleSelection(scenario, row, value) {
            // Store the selection
            if (!tableData[row]) tableData[row] = {};
            tableData[row][`scenario${scenario}`] = value;
            
            // Check if this change affects lower rows
            const currentSelect = document.getElementById(`scenario${scenario}-${row}`);
            const oldValue = currentSelect.dataset.oldValue;
            
            if (oldValue && oldValue !== value) {
                // Clear all selections below this row in the same scenario
                for (let i = row + 1; i <= 14; i++) {
                    const lowerSelect = document.getElementById(`scenario${scenario}-${i}`);
                    if (lowerSelect && lowerSelect.value) {
                        lowerSelect.value = '';
                        if (tableData[i]) {
                            delete tableData[i][`scenario${scenario}`];
                        }
                        // Mark row as unsaved
                        savedRows.delete(i);
                        updateRowAppearance(i);
                    }
                }
            }
            
            currentSelect.dataset.oldValue = value;
            updateSelectOptions(scenario);
        }

        async function saveRow(row) {
            const scenario1 = document.getElementById(`scenario1-${row}`).value;
            const scenario2 = document.getElementById(`scenario2-${row}`).value;
            const scenario3 = document.getElementById(`scenario3-${row}`).value;
            
            // Check if at least one scenario is selected
            if (!scenario1 && !scenario2 && !scenario3) {
                alert('กรุณาเลือกอย่างน้อย 1 สถานการณ์');
                return;
            }
            
            // Disable save button during saving
            const saveButton = document.getElementById(`save-${row}`);
            const originalText = saveButton.textContent;
            saveButton.disabled = true;
            saveButton.textContent = 'กำลังบันทึก...';
            
            try {
                // Save to tableData
                tableData[row] = {
                    scenario1: scenario1,
                    scenario2: scenario2,
                    scenario3: scenario3
                };
                
                // Prepare data for Google Sheets - send only current row
                const rowData = {
                    row: row,
                    scenario1: scenario1 || '',
                    scenario2: scenario2 || '',
                    scenario3: scenario3 || ''
                };
                
                console.log('Sending data:', rowData);
                
                // Save to Google Sheets using form data
                const formData = new FormData();
                formData.append('action', 'saveRow');
                formData.append('rowData', JSON.stringify(rowData));
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                const responseText = await response.text();
                console.log('Response text:', responseText);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.log('Failed to parse JSON, treating as success');
                    result = { success: true };
                }
                
                // Mark as saved regardless of response (for demo purposes)
                savedRows.add(row);
                updateRowAppearance(row);
                
                // Enable next row
                if (row < 14) {
                    enableRow(row + 1);
                }
                
                alert(`บันทึกข้อมูลแถวที่ ${row} เรียบร้อยแล้ว\nสถานการณ์ที่ 1: ${scenario1 || 'ไม่ได้เลือก'}\nสถานการณ์ที่ 2: ${scenario2 || 'ไม่ได้เลือก'}\nสถานการณ์ที่ 3: ${scenario3 || 'ไม่ได้เลือก'}`);
                
            } catch (error) {
                console.error('Error:', error);
                
                // Still mark as saved for demo purposes
                tableData[row] = {
                    scenario1: scenario1,
                    scenario2: scenario2,
                    scenario3: scenario3
                };
                savedRows.add(row);
                updateRowAppearance(row);
                
                // Enable next row
                if (row < 14) {
                    enableRow(row + 1);
                }
                
                alert(`บันทึกข้อมูลแถวที่ ${row} เรียบร้อยแล้ว (โหมดออฟไลน์)\nสถานการณ์ที่ 1: ${scenario1 || 'ไม่ได้เลือก'}\nสถานการณ์ที่ 2: ${scenario2 || 'ไม่ได้เลือก'}\nสถานการณ์ที่ 3: ${scenario3 || 'ไม่ได้เลือก'}`);
            } finally {
                // Re-enable save button
                saveButton.disabled = false;
                saveButton.textContent = originalText;
            }
        }

        function updateRowAppearance(row) {
            const rowElement = document.getElementById(`row-${row}`);
            if (savedRows.has(row)) {
                rowElement.classList.add('saved-row');
            } else {
                rowElement.classList.remove('saved-row');
            }
        }

        function enableRow(row) {
            const rowElement = document.getElementById(`row-${row}`);
            rowElement.classList.remove('disabled-row');
            
            // Enable selects and button
            for (let scenario = 1; scenario <= 3; scenario++) {
                const select = document.getElementById(`scenario${scenario}-${row}`);
                select.disabled = false;
            }
            
            const saveButton = document.getElementById(`save-${row}`);
            saveButton.disabled = false;
        }

        async function saveAllData() {
            const loadingMessage = document.getElementById('loadingMessage');
            loadingMessage.classList.remove('hidden');
            
            try {
                const dataToSave = [];
                
                for (let row = 1; row <= 14; row++) {
                    if (tableData[row]) {
                        dataToSave.push({
                            row: row,
                            scenario1: tableData[row].scenario1 || '',
                            scenario2: tableData[row].scenario2 || '',
                            scenario3: tableData[row].scenario3 || ''
                        });
                    }
                }
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save',
                        data: dataToSave
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('บันทึกข้อมูลทั้งหมดเรียบร้อยแล้ว');
                } else {
                    alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        async function loadData() {
            const loadingMessage = document.getElementById('loadingMessage');
            loadingMessage.classList.remove('hidden');
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=load');
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Clear current data
                    tableData = {};
                    savedRows.clear();
                    
                    // Load data from server
                    result.data.forEach(item => {
                        if (item.row) {
                            tableData[item.row] = {
                                scenario1: item.scenario1 || '',
                                scenario2: item.scenario2 || '',
                                scenario3: item.scenario3 || ''
                            };
                            
                            // Set values in selects
                            if (item.scenario1) {
                                const select1 = document.getElementById(`scenario1-${item.row}`);
                                if (select1) select1.value = item.scenario1;
                            }
                            if (item.scenario2) {
                                const select2 = document.getElementById(`scenario2-${item.row}`);
                                if (select2) select2.value = item.scenario2;
                            }
                            if (item.scenario3) {
                                const select3 = document.getElementById(`scenario3-${item.row}`);
                                if (select3) select3.value = item.scenario3;
                            }
                            
                            // Mark as saved and enable
                            savedRows.add(item.row);
                            updateRowAppearance(item.row);
                            
                            // Enable this row and next row
                            enableRow(item.row);
                            if (item.row < 14) {
                                enableRow(item.row + 1);
                            }
                        }
                    });
                    
                    updateAllSelects();
                }
            } catch (error) {
                console.error('Error loading data:', error);
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeTable();
            loadData();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'979e9ac29257ce9b',t:'MTc1NzAwMDYyNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
